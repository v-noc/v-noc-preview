{
  "id": "nodes/d5ab1c60-c741-4722-a945-a798de9652ce",
  "name": "definitions",
  "node_type": "file",
  "qname": "Jarvis.machinery.definitions",
  "file_path": "/Users/yared/Documents/Programing/personal/pythonJaRvis.github.io/Jarvis/tool/Jarvis/machinery/definitions.py",
  "file_name": "definitions",
  "code": "#\n# Copyright (c) 2020 Vitalis Salis.\n#\n# Licensed to the Apache Software Foundation (ASF) under one\n# or more contributor license agreements.  See the NOTICE file\n# distributed with this work for additional information\n# regarding copyright ownership.  The ASF licenses this file\n# to you under the Apache License, Version 2.0 (the\n# \"License\"); you may not use this file except in compliance\n# with the License.  You may obtain a copy of the License at\n#\n#   http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing,\n# software distributed under the License is distributed on an\n# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n# KIND, either express or implied.  See the License for the\n# specific language governing permissions and limitations\n# under the License.\n#\n\n\"\"\"FileID: d5ab1c60-c741-4722-a945-a798de9652ce\"\"\"\nimport utils\nimport heapq\nimport math\nfrom machinery import gol\n\nclass PointItem(object):\n    \"\"\"ID: 11ea1727-0490-4983-949e-82f2eb33015b\"\"\"\n    def __init__(self, row, values=set()):\n        \"\"\"ID: d0ffe58a-fe3e-426a-a99a-0c78e934b7a1\"\"\"\n        if isinstance(values, list):\n            values = set(values)\n        elif isinstance(values,str):\n            values = set([values])\n        self.points_to = values\n        self.row = row\n    def __lt__(self, other):\n        \"\"\"ID: 700d95e9-68c9-4558-9fe1-ea468720c11e\"\"\"\n        return self.row < other.row\n\n\nclass DefinitionManager(object):\n    \"\"\"ID: 82d59370-6649-4ed8-9d20-056c375f3510\"\"\"\n    def __init__(self):\n        \"\"\"ID: 5c70c66b-dcee-49be-a3ce-57eb8a7283e4\"\"\"\n        self.defs = {}\n        self.copyMap = {}\n    # \u521b\u5efa\u4e00\u4e2adef_type\u7c7b\u578b\u7684ns defi\n    def create(self, ns, def_type):\n        \"\"\"ID: e0138cd5-0e34-4106-b174-c78c4e9e545d\"\"\"\n        if not ns or not isinstance(ns, str):\n            raise DefinitionError(\"Invalid namespace argument\")\n        if def_type not in Definition.types:\n            raise DefinitionError(\"Invalid def type argument\")\n        if self.get(ns):\n            raise DefinitionError(\"Definition already exists\")\n        self.defs[ns] = Definition(ns, def_type)\n\n        return self.defs[ns]\n\n    def create_by_name(self,dict_name,ns, def_type):\n        \"\"\"ID: fcc8f219-bc94-49b1-94dd-f2aeb72dff46\"\"\"\n        if not ns or not isinstance(ns, str):\n            raise DefinitionError(\"Invalid namespace argument\")\n        if def_type not in Definition.types:\n            raise DefinitionError(\"Invalid def type argument\")\n        if self.get(dict_name):\n            raise DefinitionError(\"Definition already exists\")\n        self.defs[dict_name] = Definition(ns, def_type)\n\n        return self.defs[dict_name]\n\n\n    def get(self, ns) :\n        \"\"\"ID: ca3b7d8f-93c5-45a7-bde7-b214e13c0d53\"\"\"\n        if ns in self.defs:\n            return self.defs[ns]\n        return None\n\n    def addCopy(self,copyNs,ns):\n        \"\"\"ID: 53c64373-4daf-4ed3-8cef-de23ff02fcbd\"\"\"\n        copyDefi = self.defs.get(copyNs)\n        copyDefi.isCopy = True\n        self.copyMap[copyNs] = ns\n    def getOrCreate(self, ns, def_type):\n        \"\"\"ID: 422f0a42-25a3-418c-8ffb-ffe004bfb445\"\"\"\n        if not self.get(ns):\n            return self.create(ns, def_type)\n\n    def get_defs(self):\n        \"\"\"ID: 4d787d1a-2253-4e2c-b1c9-b6c6a79434af\"\"\"\n        return self.defs\n\n    def handle_function_def(self, parent_ns, fn_name):\n        \"\"\"ID: bbb264c7-e418-4010-ad27-4009b4fe0cd9\"\"\"\n        full_ns = utils.join_ns(parent_ns, fn_name)\n        defi = self.get(full_ns)\n        if not defi:\n            defi = self.create(full_ns, utils.constants.FUN_DEF)\n            defi.decorator_names = set()\n        else:\n            defi.decorator_names = set()\n        defi.def_type = utils.constants.FUN_DEF\n        return_ns = utils.join_ns(full_ns, utils.constants.RETURN_NAME)\n        if not self.get(return_ns):\n            self.create(return_ns, utils.constants.RETURN_DEF)\n\n        return defi\n\n    def handle_class_def(self, parent_ns, cls_name,cls_ns):\n        \"\"\"ID: 9e371152-8a79-470c-b9f7-e65f1554ad79\"\"\"\n        full_ns = utils.join_ns(cls_ns, cls_name)\n        defi: Definition = self.get(full_ns)\n        if not defi:\n            defi = self.create(full_ns, utils.constants.CLS_DEF)\n        else:\n            defi.def_type = utils.constants.CLS_DEF\n        return defi\n\n    def handle_if_def(self, parent_ns, if_name,def_type = utils.constants.IF_DEF):\n        \"\"\"ID: fa6f5e5b-a1e0-43cb-8bcd-d33ced206630\"\"\"\n        full_ns = utils.join_ns(parent_ns, if_name)\n        defi = self.get(full_ns)\n        if not defi:\n            defi = self.create(full_ns,def_type)\n        return defi\n\n    def transform_defi(self, ns, row) -> list:\n        \"\"\"ID: bd8b8a39-013f-4fcb-98e6-1423c4b97cef\"\"\"\n        defi: Definition = self.defs.get(ns)\n        transDefiNames = []\n        for point_ns in defi.get_name_pointer(row):\n            transDefiNames.append(point_ns)\n        return transDefiNames\n\n    def get_final_pointName(self, defiNs, row):\n        \"\"\"ID: 9d3ee7ce-f152-473f-af3c-52ff9a322340\"\"\"\n        curDefi: Definition = self.get(defiNs)\n        if not curDefi:\n            return [defiNs], row\n        if not curDefi.points:\n            return [defiNs], row\n        # pointItem: PointItem = curDefi.get_point(row)\n        pointValues:set() = curDefi.get_last_point_value()\n        if not pointValues:\n            pointValues = curDefi.get_last_point_value()\n            if not pointValues:\n                return [defiNs],row\n        return pointValues,row\n\n    def get_scope_name(self, ns: str):\n        \"\"\"ID: 2ba11a01-d630-4c46-a5f7-ff485df567c6\"\"\"\n        while ns.rfind('.') != -1:\n            rIndex = ns.rfind('.')\n            scopeNs = ns[:rIndex]\n            if self.get(scopeNs) and self.get(scopeNs).get_type() in [utils.constants.MOD_DEF,\n                                                                      utils.constants.CLS_DEF,\n                                                                      utils.constants.FUN_DEF,\n                                                                      ]:\n                return scopeNs\n            ns = scopeNs\n\n    def get_module_name(self, ns: str):\n        \"\"\"ID: b0d273f3-df4b-4883-bf04-7c1bd6023dad\"\"\"\n        while ns.rfind('.') != -1:\n            rIndex = ns.rfind('.')\n            moduleNs = ns[:rIndex]\n            if self.get(moduleNs) and self.get(moduleNs).get_type() == utils.constants.MOD_DEF:\n                return moduleNs\n            ns = moduleNs\n\n    def is_same_scope(self, first, second):\n        \"\"\"ID: 73513dd8-84f4-46eb-ae0e-c6ed634cb097\"\"\"\n        return self.get_scope_name(first) == self.get_scope_name(second)\n\n    def helper(self, defiNs, row):\n        \"\"\"ID: 1a337601-8d3c-4df5-abc2-c91c441aa729\"\"\"\n        curDefi: Definition = self.get(defiNs)\n        if not curDefi:\n            return defiNs\n        if not curDefi.points:\n            return defiNs\n\n    def get_last_final_pointName(self, defiNs) -> list:\n        \"\"\"ID: 7cead2d5-c022-41c3-8165-e78ec4419b3f\"\"\"\n        queue = [defiNs]\n        finalDefiNsList = []\n        while queue:\n            curDefiNs = queue[0]\n            queue.remove(curDefiNs)\n            curDefi: Definition = self.get(curDefiNs)\n            curItemLists = curDefi.get_last_point_value()\n            if not curItemLists:\n                finalDefiNsList.append(curDefiNs)\n            else:\n                queue += curItemLists\n        return finalDefiNsList\n\n\nclass Definition(object):\n    \"\"\"ID: f5f3d546-7852-4565-8e17-7f5470b41263\"\"\"\n    types = [\n        utils.constants.FUN_DEF,\n        utils.constants.MOD_DEF,\n        utils.constants.NAME_DEF,\n        utils.constants.CLS_DEF,\n        utils.constants.EXT_DEF,\n        utils.constants.IF_DEF,\n        utils.constants.ELSE_DEF,\n        utils.constants.WHILE_DEF,\n        utils.constants.PARAM_DEF,\n        utils.constants.NA_DEF,\n        utils.constants.RETURN_DEF,\n        utils.constants.INT_DEF,\n        utils.constants.STR_DEF,\n        utils.constants.LIST_DEF,\n        utils.constants.MAP_DEF,\n    ]\n\n    def __init__(self, fullns, def_type):\n        \"\"\"ID: 495a87db-98f2-4250-b089-9edb7d69bbef\"\"\"\n        self.fullns = fullns\n        self.def_type = def_type\n        self.points = []\n        self.bias = set()\n        self.lines = set()\n\n    def get_point(self, row) -> PointItem:\n        \"\"\"ID: 9a93221d-4ac9-4180-b097-51585696da16\"\"\"\n        cur_point = None\n        for point in self.points:\n            if point.row <= row:\n                cur_point = point\n            else:\n                break\n        return cur_point\n\n    def clear_point(self):\n        \"\"\"ID: 5de833be-fe9c-48cd-a1d9-e13fc53c5910\"\"\"\n        self.points = []\n\n    # \u6dfb\u52a0\u4e00\u4e2anamePointItem\n\n    def add_value_point(self, row, values):\n        \"\"\"ID: 874cf03e-1063-4a63-a0e2-ed3faa4eaa62\"\"\"\n        curPoint = None\n        point = PointItem(row, values)\n        heapq.heappush(self.points, point)\n        if isinstance(values,str):\n            values = [values]\n        if not gol.get_value('precision'):\n            self.bias = self.bias.union(set(values))\n\n    def get_type(self):\n        \"\"\"ID: 85c5e032-e4b3-4f0f-ab12-d7677d016c98\"\"\"\n        return self.def_type\n\n    def is_function_def(self):\n        \"\"\"ID: f0e939e3-cdb3-4e02-bd40-ea639f716011\"\"\"\n        return self.def_type == utils.constants.FUN_DEF\n\n    def is_ext_def(self, row=0):\n        \"\"\"ID: 249ea36a-461e-46ea-b48c-b4de4cdb5860\"\"\"\n        return self.def_type == utils.constants.EXT_DEF\n\n    def is_callable(self):\n        \"\"\"ID: a80645aa-d435-40e9-bea8-d50ea44d916e\"\"\"\n        return self.is_function_def() or self.is_ext_def()\n\n    # \u62ff\u5230PointItem\u7684value\n\n    def get_name(self):\n        \"\"\"ID: 5eb038d3-871e-47e3-a4df-47b95935d31c\"\"\"\n        return self.fullns.split(\".\")[-1]\n\n    def get_ns(self):\n        \"\"\"ID: 2d90a126-ca55-4fab-80ff-2bbeba0673b5\"\"\"\n        return self.fullns\n\n\n\n    def get_last_point_value(self):\n        \"\"\"ID: 3b34a6de-0ef3-4a3b-ab7d-6c60b5e60ce4\"\"\"\n        if not self.points:\n            return set()\n        return self.points[len(self.points) - 1].points_to.union(self.bias)\n    def set_element(self,key,value):\n        \"\"\"ID: 553e97b2-7eac-41c2-94de-767e38ec0904\"\"\"\n        if self.def_type not in [utils.constants.LIST_DEF, utils.constants.MAP_DEF]:\n            return\n            # raise DefinitionError(\"the definition doesn't belong to [List or Dict]\")\n        if not getattr(self,'memo',None):\n            self.memo = {}\n        self.memo[key] = value\n\n    def get_element(self,key):\n        \"\"\"ID: 0ccb41f1-8f72-4c2f-89fb-8d5b49af9699\"\"\"\n        if key not in self.memo:\n            return []\n        return self.memo[key]\n    def del_element(self,key):\n        \"\"\"ID: 7092a8db-f289-4c42-b39b-9db63579e356\"\"\"\n        if self.def_type not in [utils.constants.LIST_DEF, utils.constants.MAP_DEF]:\n            raise DefinitionError(\"the definition doesn't belong to [List or Dict]\")\n        if not getattr(self,'memo'):\n            return\n        del self.memo[key]\nclass ChangeManager:\n    \"\"\"ID: 7065d615-46ff-41f3-b61a-af8c1599d03e\"\"\"\n    def __init__(self):\n        \"\"\"ID: f6125e7c-8e02-40f8-bc4b-b17a8d2847d1\"\"\"\n        self.changes = {}\n\n    def getChange(self, ns):\n        \"\"\"ID: 4681b1fe-2681-47fc-92ee-6ff793120fc6\"\"\"\n        if ns in self.changes:\n            return self.changes[ns]\n        self.changes[ns] = {}\n        return self.changes[ns]\n\n    def addChange(self, ns, defins, row, values):\n        \"\"\"ID: 16d677c3-6944-479c-b31e-6e217c445c78\"\"\"\n        if ns not in self.changes:\n            self.changes[ns] = {}\n        item = ChangeItem(row, values)\n        if defins not in self.changes[ns]:\n            # self.changes[ns].setdefault(defins, item)\n            self.changes[ns][defins] = item\n        else:\n            self.changes[ns].get(defins).addPoint(row,values)\n\nclass ChangeItem(Definition):\n    \"\"\"ID: 5bfe6df0-4c99-4d02-83f6-319a5e6bc7db\"\"\"\n    def __init__(self, row, values,if_union = False):\n        \"\"\"ID: c8962097-c2a6-46f4-b0f6-696f8005bbe6\"\"\"\n        self.points = []\n        self.bias = set()\n        self.if_union = if_union\n        self.add_value_point(row,values)\n    def addPoint(self,row,values):\n        \"\"\"ID: a6e7f066-999c-48a0-94fa-7b47515aa476\"\"\"\n        point = PointItem(row,values)\n        heapq.heappush(self.points,point)\nclass DefinitionError(Exception):\n    \"\"\"ID: f4ad934f-22b6-4cf6-a077-646bab29131f\"\"\"\n    pass\n"
}