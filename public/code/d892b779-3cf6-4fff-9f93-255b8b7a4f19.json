{
  "id": "nodes/d892b779-3cf6-4fff-9f93-255b8b7a4f19",
  "name": "scopes",
  "node_type": "file",
  "qname": "Jarvis.machinery.scopes",
  "file_path": "/Users/yared/Documents/Programing/personal/pythonJaRvis.github.io/Jarvis/tool/Jarvis/machinery/scopes.py",
  "file_name": "scopes",
  "code": "#\n# Copyright (c) 2020 Vitalis Salis.\n#\n# Licensed to the Apache Software Foundation (ASF) under one\n# or more contributor license agreements.  See the NOTICE file\n# distributed with this work for additional information\n# regarding copyright ownership.  The ASF licenses this file\n# to you under the Apache License, Version 2.0 (the\n# \"License\"); you may not use this file except in compliance\n# with the License.  You may obtain a copy of the License at\n#\n#   http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing,\n# software distributed under the License is distributed on an\n# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n# KIND, either express or implied.  See the License for the\n# specific language governing permissions and limitations\n# under the License.\n#\n\"\"\"FileID: d892b779-3cf6-4fff-9f93-255b8b7a4f19\"\"\"\nimport symtable\n\n\nimport utils\nimport copy\n\nclass ScopeManager(object):\n    \"\"\"Manages the scope entries\n\nID: b5c0dbc1-dd37-426f-8bc7-107c1fec9874\"\"\"\n\n    def __init__(self):\n        \"\"\"ID: eac32f56-f89f-49e2-8c67-3f3979c9892a\"\"\"\n        self.scopes = {}\n        self.copySeq = {}\n    def handle_module(self, modulename, filename, contents):\n        \"\"\"ID: 330b1663-4ce7-4c2f-96ba-4a10746e261c\"\"\"\n        functions = []\n        classes = []\n        def process(namespace, parent, table):\n            \"\"\"ID: 6c4f4996-b235-4c8a-96c4-48f660a59f8a\"\"\"\n            name = table.get_name() if table.get_name() != 'top' else ''\n            if name:\n                fullns = utils.join_ns(namespace, name)\n            else:\n                fullns = namespace\n\n            if table.get_type() == \"function\":\n                functions.append(fullns)\n\n            if table.get_type() == \"class\":\n                classes.append(fullns)\n\n            sc = self.create_scope(fullns, parent)\n\n            for t in table.get_children():\n                process(fullns, sc, t)\n\n        process(modulename, None, symtable.symtable(contents, filename, compile_type=\"exec\"))\n        return {\"functions\": functions, \"classes\": classes}\n\n    def add_defi(self, ns, target, defi):\n        \"\"\"ID: 07f6481d-bf49-472b-bc0a-79265f32882c\"\"\"\n        scope = self.get_scope(ns)\n        if scope:\n            scope.add_def(target, defi)\n\n    def handle_assign(self, ns, target, defi):\n        \"\"\"ID: 01c87278-e130-4c10-b93d-7d6ed4759c86\"\"\"\n        scope = self.get_scope(ns)\n        if scope:\n            scope.add_def(target, defi)\n    def add_params(self, ns, defi):\n        \"\"\"ID: 4278a582-8c6b-4cf8-a456-a1d94b146c64\"\"\"\n        scope = self.get_scope(ns)\n        if scope:\n            scope.add_params(defi)\n    def get_def(self, current_ns, var_name):\n        \"\"\"ID: 589bdc56-392f-4563-a500-6fe3f7ed02b9\"\"\"\n        current_scope = self.get_scope(current_ns)\n        while current_scope:\n            defi= current_scope.get_def(var_name)\n            if defi:\n                return defi\n            current_scope = current_scope.parent\n    def get_scope(self, namespace):\n        \"\"\"ID: a56f2399-550d-4f4f-ac01-7fbc376da65a\"\"\"\n        if namespace in self.get_scopes():\n            return self.get_scopes()[namespace]\n\n    def create_scope(self, namespace, parent):\n        \"\"\"ID: e077c12e-0188-450f-bd11-14d9fc167350\"\"\"\n        if not namespace in self.scopes:\n            sc = ScopeItem(namespace, parent)\n            self.scopes[namespace] = sc\n        return self.scopes[namespace]\n\n    def create_scope_by_name(self,dict_name,namespace,parent):\n        \"\"\"ID: f4962a58-3cc8-4edd-ad40-8840262cf5ec\"\"\"\n        if not namespace in self.scopes:\n            sc = ScopeItem(namespace, parent)\n            self.scopes[dict_name] = sc\n        return self.scopes[dict_name]\n    def add_scope(self,namespace,item,parent):\n        \"\"\"ID: 1ba80ada-c029-47bd-aef4-98e97da67d8b\"\"\"\n        if not namespace in self.scopes:\n            self.scopes[namespace] = item\n            item.parent = parent\n    def get_scopes(self):\n        \"\"\"ID: 2bdff7c1-2adb-4bca-b147-5d34949050f6\"\"\"\n        return self.scopes\n\n    def add_seq(self,ns):\n        \"\"\"ID: 15d91822-86e9-4cac-a6ef-aa8645efa5cf\"\"\"\n        if ns in self.copySeq:\n            self.copySeq[ns] += 1\n        else:\n            self.copySeq[ns] = 1\n        return self.copySeq[ns]\n\n    def get_seq(self,ns):\n        \"\"\"ID: 45d0ec9c-2b7b-4188-8b80-c3f655c231e6\"\"\"\n        if ns in self.copySeq:\n            return self.copySeq[ns]\n        return 0\n\n    def add_inputs(self,ns,*args):\n        \"\"\"ID: b4d1dfa1-4a1d-42b5-9fc7-62d6d8ad616c\"\"\"\n        scope = self.get_scope(ns)\n        if scope:\n            scope.add_inputs(args)\n\nclass ScopeItem(object):\n    \"\"\"ID: ff559ffe-3c5e-4938-b20b-2b24f19b60fa\"\"\"\n    def __init__(self, fullns, parent):\n        \"\"\"ID: c849a6c9-6106-4ebf-bd65-6f2d3752da4b\"\"\"\n        if parent and not isinstance(parent, ScopeItem):\n            raise ScopeError(\"Parent must be a ScopeItem instance\")\n\n        if not isinstance(fullns, str):\n            raise ScopeError(\"Namespace should be a string\")\n\n        self.parent = parent\n        self.defs = {}\n        self.lambda_counter = 0\n        self.dict_counter = 0\n        self.list_counter = 0\n        self.if_counter = 0\n        self.while_counter = 0\n        self.fullns = fullns\n        self.params = []\n        self.inputs = set()\n    def get_ns(self):\n        \"\"\"ID: 650760ab-3942-4780-9dbe-676508bfe734\"\"\"\n        return self.fullns\n\n    def get_defs(self):\n        \"\"\"ID: 98ec9661-80e1-4e0c-897b-fb813fd95410\"\"\"\n        return self.defs\n\n    def add_params(self,defi):\n        \"\"\"ID: ea78efa2-35ac-49f8-b985-d519c7e176c4\"\"\"\n        self.params.append(defi)\n    def get_def(self, name):\n        \"\"\"ID: 5974ccb2-75ec-4215-878c-668f979d95fd\"\"\"\n        defs = self.get_defs()\n        if name in defs:\n            return defs[name]\n        return None\n\n    def add_inputs(self,*args):\n        \"\"\"ID: 55c77a01-3915-4dff-a85b-97bab329af55\"\"\"\n        for i in args:\n            self.inputs = self.inputs.union(i)\n    def get_lambda_counter(self):\n        \"\"\"ID: 512e07ec-289d-4d2e-936c-f300f7160231\"\"\"\n        return self.lambda_counter\n\n    def get_dict_counter(self):\n        \"\"\"ID: bd5b9f29-1921-4c3b-bfac-8cedef6057a4\"\"\"\n        return self.dict_counter\n\n    def get_list_counter(self):\n        \"\"\"ID: b3488764-8f5a-4e70-a14c-0cb9a622ef5b\"\"\"\n        return self.list_counter\n\n    def get_if_counter(self):\n        \"\"\"ID: 4f957d0a-00d9-4826-8768-70bd118a279b\"\"\"\n        return self.if_counter\n\n    def get_while_counter(self):\n        \"\"\"ID: 7159bdd8-c7d9-481e-ac2e-9253449ee994\"\"\"\n        return self.while_counter\n\n    def inc_lambda_counter(self, val=1):\n        \"\"\"ID: f0b1cb6f-3493-40d6-bec5-4c52a8c72094\"\"\"\n        self.lambda_counter += val\n        return self.lambda_counter\n\n    def inc_dict_counter(self, val=1):\n        \"\"\"ID: 46850c46-de9f-4c89-831d-ebd0ad781e7a\"\"\"\n        self.dict_counter += val\n        return self.dict_counter\n\n    def inc_list_counter(self, val=1):\n        \"\"\"ID: 97194f1f-14f1-4a2a-b9c6-785c32392e7c\"\"\"\n        self.list_counter += val\n        return self.list_counter\n\n    def inc_if_counter(self,val=1):\n        \"\"\"ID: 02715ace-274e-4e92-b342-124448ebb9d2\"\"\"\n        self.if_counter += val\n        return self.if_counter\n\n    def inc_while_counter(self,val=1):\n        \"\"\"ID: 1cb166ad-8e07-44a5-9f56-44b07ac6be45\"\"\"\n        self.while_counter += val\n        return self.while_counter\n\n    def reset_counters(self):\n        \"\"\"ID: 80a57f81-486c-4ff7-b9ec-5623b09fadbf\"\"\"\n        self.lambda_counter = 0\n        self.dict_counter = 0\n        self.list_counter = 0\n        self.if_counter = 0\n        self.while_counter = 0\n\n    # \u5728scopt_item\u6dfb\u52a0\u4e00\u4e2adefi\n    def add_def(self, name, defi):\n        \"\"\"ID: 6bd4570a-5038-447b-ac0c-bcae98ff1ba2\"\"\"\n        self.defs[name] = defi\n\n    def merge_def(self, name, to_merge):\n        \"\"\"ID: 711349ee-a16d-40a8-8846-6d51e0a39b2f\"\"\"\n        if not name in self.defs:\n            self.defs[name] = to_merge\n            return\n\n        self.defs[name].merge_points_to(to_merge.get_points_to())\n\n\n    def get_prefix_defi(self,prefix:str)->list:\n        \"\"\"ID: ef9a7afc-7be6-44ce-8bbd-573165dbea89\"\"\"\n        defiNameList = []\n        for defi in self.defs.values():\n            if defi.get_ns().startswith(prefix):\n                defiNameList.append(defi)\n        return defiNameList\n\n    def get_params_defiNs(self)->list:\n        \"\"\"ID: cf4e2780-a1e3-411e-a8b5-b5a15f7dfb96\"\"\"\n        paramsDefiList = []\n        for param in self.params:\n            if param.get_type() == utils.constants.NAME_DEF:\n                continue\n            paramsDefiList += self.get_prefix_defi(param.get_ns())\n        return paramsDefiList\n\n    def __str__(self):\n        \"\"\"ID: d3125d58-a047-4fa1-9475-fa54bb415f26\"\"\"\n        def find_ns(ns):\n            \"\"\"ID: 63d448c7-b634-4c57-a2d1-9fd5b76bd142\"\"\"\n            for defiNs,defi in self.defs.items():\n                if defi.get_ns() == ns:\n                    return defi\n            return None\n        ans = self.fullns\n        ans += \"-\"\n        for param in self.params:\n            paramDefi = find_ns(param.get_ns())\n            if not param:\n                continue\n            else:\n                pointValue = param.get_last_point_value()\n                if not pointValue:\n                    tmp = param.get_ns() + \":\" + \"None\"\n                else:\n                    tmp = param.get_ns() + \":\" + utils.join_ns(*list(pointValue))\n            ans += tmp\n            ans += \"-\"\n        return ans\nclass ScopeError(Exception):\n    \"\"\"ID: 54d40a2d-7030-4afe-80df-121facea7c07\"\"\"\n    pass\n"
}