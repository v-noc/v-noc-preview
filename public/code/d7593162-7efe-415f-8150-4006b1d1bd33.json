{
  "id": "nodes/d7593162-7efe-415f-8150-4006b1d1bd33",
  "name": "imports",
  "node_type": "file",
  "qname": "Jarvis.machinery.imports",
  "file_path": "/Users/yared/Documents/Programing/personal/pythonJaRvis.github.io/Jarvis/tool/Jarvis/machinery/imports.py",
  "file_name": "imports",
  "code": "#\n# Copyright (c) 2020 Vitalis Salis.\n#\n# Licensed to the Apache Software Foundation (ASF) under one\n# or more contributor license agreements.  See the NOTICE file\n# distributed with this work for additional information\n# regarding copyright ownership.  The ASF licenses this file\n# to you under the Apache License, Version 2.0 (the\n# \"License\"); you may not use this file except in compliance\n# with the License.  You may obtain a copy of the License at\n#\n#   http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing,\n# software distributed under the License is distributed on an\n# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n# KIND, either express or implied.  See the License for the\n# specific language governing permissions and limitations\n# under the License.\n#\n\n\"\"\"FileID: d7593162-7efe-415f-8150-4006b1d1bd33\"\"\"\nimport sys\nimport ast\nimport os\nimport importlib\nimport copy\nimport pkg_resources\nimport utils\n\ndef get_custom_loader(ig_obj):\n    \"\"\"Closure which returns a custom loader\nthat modifies an ImportManager object\n\nID: 45de7d63-5a96-41ed-bdc5-87d6cac44fd1\"\"\"\n    class CustomLoader(importlib.abc.SourceLoader):\n        \"\"\"ID: b32f7c78-194a-470a-9650-cf4ec742c24b\"\"\"\n        def __init__(self, fullname, path):\n            \"\"\"ID: ec7842ba-010e-4fd4-bf77-8d7a22a21adf\"\"\"\n            self.fullname = fullname\n            self.path = path\n\n            ig_obj.create_edge(self.fullname)\n            if not ig_obj.get_node(self.fullname):\n                ig_obj.create_node(self.fullname)\n                ig_obj.set_filepath(self.fullname, self.path)\n\n        def get_filename(self, fullname):\n            \"\"\"ID: 530e2b3e-98c4-47dc-9e2d-7b77490bc617\"\"\"\n            return self.path\n\n        def get_data(self, filename):\n            \"\"\"ID: ef3c17bf-db56-43c7-8c7f-9e8f9d8a7f22\"\"\"\n            return \"\"\n\n    return CustomLoader\n\nclass ImportManager(object):\n    \"\"\"ID: 258511ee-e9d2-4d8f-a6ab-4ffd6692a293\"\"\"\n    def __init__(self):\n        \"\"\"ID: b20725c6-b0dd-494c-b68e-8c9b4cf8bd6d\"\"\"\n        self.import_graph = dict()\n        self.current_module = \"\"\n        self.input_file = \"\"\n        self.mod_dir = None\n        self.old_path_hooks = None\n        self.old_path = None\n\n    def set_pkg(self, input_pkg):\n        \"\"\"ID: 25daa120-ca37-4199-aa76-a4b53504ddf1\"\"\"\n        self.mod_dir = input_pkg\n\n    def get_mod_dir(self):\n        \"\"\"ID: 0b75a57b-0cfb-45c8-8109-6b84fdfebbdc\"\"\"\n        return self.mod_dir\n\n    def get_node(self, name):\n        \"\"\"ID: 8c17e5a4-b296-420c-9430-de802ea9c927\"\"\"\n        if name in self.import_graph:\n            return self.import_graph[name]\n\n    def create_node(self, name):\n        \"\"\"ID: 2e7ed7ed-3290-4e43-ab16-4019161fd0d5\"\"\"\n        if not name or not isinstance(name, str):\n            raise ImportManagerError(\"Invalid node name\")\n\n        if self.get_node(name):\n            return\n            raise ImportManagerError(\"Can't create a node a second time\")\n\n        self.import_graph[name] = {\"filename\": \"\", \"imports\": set()}\n        return self.import_graph[name]\n\n    def create_edge(self, dest):\n        \"\"\"ID: 0800561a-8514-42b5-aad5-ec0a3ff8edc0\"\"\"\n        if not dest or not isinstance(dest, str):\n            raise ImportManagerError(\"Invalid node name\")\n\n        node = self.get_node(self._get_module_path())\n        if not node:\n            return\n            # raise ImportManagerError(\"Can't add edge to a non existing node\")\n\n        node[\"imports\"].add(dest)\n\n\n    def _clear_caches(self):\n        \"\"\"ID: f070d3bb-f82c-484a-8183-1c3335c9553f\"\"\"\n        importlib.invalidate_caches()\n        sys.path_importer_cache.clear()\n\n\n    def _get_module_path(self):\n        \"\"\"ID: 9b7c2371-0731-4ef0-a517-2d670a7dd243\"\"\"\n        return self.current_module\n\n    def set_current_mod(self, name, fname):\n        \"\"\"ID: 4c61ebbc-5472-48ad-a4ea-cfcc71319b10\"\"\"\n        self.current_module = name\n        self.input_file = os.path.abspath(fname)\n\n    def get_filepath(self, modname):\n        \"\"\"ID: dcd90720-a0bf-4e78-9cf5-834ecae6ead2\"\"\"\n        if modname in self.import_graph:\n            return self.import_graph[modname][\"filename\"]\n\n    def set_filepath(self, node_name, filename):\n        \"\"\"ID: 9c5dd1ef-9566-445d-a99b-6760ed07fb30\"\"\"\n        if not filename or not isinstance(filename, str):\n            raise ImportManagerError(\"Invalid node name\")\n\n        node = self.get_node(node_name)\n        if not node:\n            raise ImportManagerError(\"Node does not exist\")\n\n        node[\"filename\"] = os.path.abspath(filename)\n\n    #   todo \u5f97\u5230\u7248\u672c\u53f7\n    def set_version(self, node_name, version):\n        \"\"\"ID: 7ac63847-f605-48da-a37c-bbbfa57b7c4e\"\"\"\n        if not version or not isinstance(version, str):\n            raise ImportManagerError(\"Invalid node name\")\n\n        node = self.get_node(node_name)\n        if not node:\n            raise ImportManagerError(\"Node does not exist\")\n\n        node[\"version\"] = os.path.abspath(version)\n\n    def get_imports(self, modname):\n        \"\"\"ID: 52d23447-85e2-4a84-bb8f-0afe0cd65a66\"\"\"\n        if not modname in self.import_graph:\n            return []\n        return self.import_graph[modname][\"imports\"]\n\n\n    def _is_init_file(self):\n        \"\"\"ID: 499bbdec-6af0-441c-ab2f-ee1f18c0335d\"\"\"\n        return self.input_file.endswith(\"__init__.py\")\n\n    def _handle_import_level(self, name, level):\n        \"\"\"ID: 382c9d3c-1adb-4498-ac6e-37efd264d066\"\"\"\n        # add a dot for each level\n        package = self._get_module_path().split(\".\")\n        if level > len(package):\n            raise ImportError(\"Attempting import beyond top level package\")\n\n        mod_name = (\".\" * level) + name\n        # When an __init__ file is analyzed, then the module name doesn't contain\n        # the __init__ part in it, so special care must be taken for levels.\n        if self._is_init_file() and level >= 1:\n            if level != 1:\n                level -= 1\n                package = package[:-level]\n        else:\n            package = package[:-level]\n\n        return mod_name, \".\".join(package)\n\n    def _do_import(self, mod_name, package):\n        \"\"\"ID: ac2c6527-3ea2-4a8a-b9dd-d3feaa10f97f\"\"\"\n        if mod_name == 'pdb':\n            return\n        if mod_name in sys.modules:\n            mod = sys.modules[mod_name]\n            self.create_edge(mod_name)\n            if not hasattr(mod, \"__file__\") or not mod.__file__:\n                return\n            self.create_node(mod_name)\n            self.set_filepath(mod_name,mod.__file__)\n            return sys.modules[mod_name]\n        module_spec = importlib.util.find_spec(mod_name, package=package)\n        if module_spec is None:\n            return importlib.import_module(mod_name, package=package)\n        return importlib.util.module_from_spec(module_spec)\n\n    def get_version(self,mod_name):\n        \"\"\"ID: 455000a3-a495-4765-b791-d5cb636daafb\"\"\"\n        tmp = pkg_resources.find_distributions(mod_name,True)\n        print(tmp)\n        pass\n    def handle_import(self, name, level,curScope=None):\n        \"\"\"ID: 522b1a61-0fbd-4bc9-af1e-b6a4217e4806\"\"\"\n        # We currently don't support builtin modules because they're frozen.\n        # Add an edge and continue.\n        # TODO: identify a way to include frozen modules\n        # \u5982\u679c\u662f\u5185\u90e8\u6a21\u5757\uff0c\u662f\u76f4\u63a5\u52a0\u5165\n        root = name.split(\".\")[0]\n        if root in sys.builtin_module_names:\n            self.create_edge(root)\n            return\n\n        # Import the module\n        # \u5982\u679c\u662f\u5916\u90e8\u6a21\u5757\uff0c\u5219\u9700\u8981\u52a8\u6001\u5bfc\u5165\uff0c\u4e0e\u73af\u5883\u76f8\u5173\n        try:\n            mod_name, package = self._handle_import_level(name, level)\n        except ImportError:\n            return\n\n        parent = \".\".join(mod_name.split(\".\")[:-1])\n        parent_name = \".\".join(name.split(\".\")[:-1])\n        combos = [(mod_name, package),\n                (parent, package),\n                (utils.join_ns(package, name), \"\"),\n                (utils.join_ns(package, parent_name), \"\")]\n\n        mod = None\n        for mn, pkg in combos:\n            try:\n                mod = self._do_import(mn, pkg)\n                break\n            except:\n                continue\n\n        if not mod:\n            return\n\n        if not hasattr(mod, \"__file__\") or not mod.__file__:\n            return\n        # \u5982\u679c\u662f\u5916\u90e8\u6a21\u5757\uff0c\u5219\u76f4\u63a5\u8fd4\u56de\u6a21\u5757\u540d\n        if self.mod_dir not in mod.__file__:\n            return mod.__name__\n        # if self.mod_dir not in mod.__file__:\n        #     return mod\n        # \u5982\u679c\u662f\u5185\u90e8\u6a21\u5757\uff0c\u8fd4\u56de\u76f8\u5bf9\u8def\u5f84\n        fname = mod.__file__\n        if fname.endswith(\"__init__.py\"):\n            fname = os.path.split(fname)[0]\n\n        return utils.to_mod_name(\n            os.path.relpath(fname, self.mod_dir))\n\n    def get_import_graph(self):\n        \"\"\"ID: 8822333b-a0df-4234-9647-ecbe80ed3fa0\"\"\"\n        return self.import_graph\n\n    def install_hooks(self):\n        \"\"\"ID: dc3fd211-5ad2-40df-a80b-d29e3a201f1d\"\"\"\n        loader = get_custom_loader(self)\n        self.old_path_hooks = copy.deepcopy(sys.path_hooks)\n        self.old_path = copy.deepcopy(sys.path)\n        loader_details = loader, importlib.machinery.all_suffixes()\n        sys.path_hooks.insert(0, importlib.machinery.FileFinder.path_hook(loader_details))\n        sys.path.insert(0, os.path.abspath(self.mod_dir))\n        sys.path.append(os.path.abspath(self.mod_dir))\n        self._clear_caches()\n\n    def remove_hooks(self):\n        \"\"\"ID: a3f8a734-40e7-4eb6-bb9a-2b85c13033cd\"\"\"\n        sys.path_hooks = self.old_path_hooks\n        sys.path = self.old_path\n\n        self._clear_caches()\n\nclass ImportManagerError(Exception):\n    \"\"\"ID: 9993afe1-6927-40d2-8884-a024afaba05e\"\"\"\n    pass\n"
}